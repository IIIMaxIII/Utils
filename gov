#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è governors CPU
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sudo ./governor.sh [p|ps|o|s|cur]

GOVERNOR="${1:-cur}"
AVAILABLE_GOVERNORS=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors 2>/dev/null)

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;94m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# –ò–∫–æ–Ω–∫–∏
ICON_CPU="üíª"
ICON_PERF="üöÄ"
ICON_SAVE="üîã"
ICON_ADAPT="‚ö°"
ICON_CUR="üìä"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}√ó${NC} –¢—Ä–µ–±—É—é—Ç—Å—è root –ø—Ä–∞–≤–∞"
    exit 1
fi

get_cpu_info() {
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–ø–æ–ª–æ–≥–∏–∏
    PHYSICAL_CORES=$(lscpu | grep "Core(s) per socket" | awk '{print $4}')
    SOCKETS=$(lscpu | grep "Socket(s)" | awk '{print $2}')
    THREADS_PER_CORE=$(lscpu | grep "Thread(s) per core" | awk '{print $4}')
    
    TOTAL_PHYSICAL_CORES=$((PHYSICAL_CORES * SOCKETS))
    TOTAL_THREADS=$((TOTAL_PHYSICAL_CORES * THREADS_PER_CORE))
    
    echo "${TOTAL_PHYSICAL_CORES}:${TOTAL_THREADS}:${THREADS_PER_CORE}"
}

show_compact_freq() {
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–ø–æ–ª–æ–≥–∏–∏
    IFS=":" read -r PHYSICAL_CORES TOTAL_THREADS THREADS_PER_CORE <<< $(get_cpu_info)
    
    echo -e "${BLUE}‚îî‚îÄ‚îÄ –ß–∞—Å—Ç–æ—Ç—ã –ø–æ—Ç–æ–∫–æ–≤:${NC}"
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–∞—Å—Ç–æ—Ç—ã
    freqs=$(cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq | awk '{printf "%.1f\n", $1/1000000}')
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–∞–º
    freq_stats=$(echo "$freqs" | sort -n | uniq -c | awk '{printf "   %d @ %s GHz\n", $1, $2}')
    
    # –í—ã–≤–æ–¥–∏–º –∫–æ–º–ø–∞–∫—Ç–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if [ $(echo "$freq_stats" | wc -l) -eq 1 ]; then
        echo -e "   ${GREEN}–í—Å–µ @ $(echo "$freqs" | head -1) GHz${NC}"
    else
        echo "$freq_stats"
    fi
    
}

show_current() {
    CURRENT_GOV=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–ø–æ–ª–æ–≥–∏–∏
    IFS=":" read -r PHYSICAL_CORES TOTAL_THREADS THREADS_PER_CORE <<< $(get_cpu_info)
    
    echo -e "${CYAN}${ICON_CUR} –¢–µ–∫—É—â–∏–π: ${PURPLE}${CURRENT_GOV}${NC}"
    echo -e "${BLUE}‚îú‚îÄ‚îÄ –¢–æ–ø–æ–ª–æ–≥–∏—è: ${YELLOW}${PHYSICAL_CORES} —è–¥–µ—Ä √ó ${THREADS_PER_CORE} –ø–æ—Ç–æ–∫–∞ = ${TOTAL_THREADS} –ø–æ—Ç–æ–∫–æ–≤${NC}"
    show_compact_freq
}

set_governor() {
    local target_gov="$1"
    local icon="$2"
    local name="$3"
    
    echo -e "${icon} –£—Å—Ç–∞–Ω–æ–≤–∫–∞: ${GREEN}${name}${NC}"
    
    for gov_file in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
        echo "$target_gov" > "$gov_file"
    done
    
    sleep 0.3
    show_current
}

case "${GOVERNOR}" in
    "p"|"perf"|"performance")
        set_governor "performance" "${ICON_PERF}" "–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨"
        ;;
    "ps"|"powersave")
        set_governor "powersave" "${ICON_SAVE}" "–≠–ù–ï–†–ì–û–°–ë–ï–†–ï–ñ–ï–ù–ò–ï"
        ;;
    "o"|"ondemand")
        set_governor "ondemand" "${ICON_ADAPT}" "–ê–î–ê–ü–¢–ò–í–ù–´–ô –†–ï–ñ–ò–ú"
        ;;
    "s"|"schedutil")
        set_governor "schedutil" "${ICON_ADAPT}" "–°–û–í–†–ï–ú–ï–ù–ù–´–ô –ê–î–ê–ü–¢–ò–í–ù–´–ô"
        ;;
    "cur"|"current"|"")
        echo -e "${CYAN}${ICON_CPU} –°–æ—Å—Ç–æ—è–Ω–∏–µ CPU${NC}"
        echo -e "${BLUE}‚îú‚îÄ‚îÄ –î–æ—Å—Ç—É–ø–Ω—ã–µ: ${YELLOW}${AVAILABLE_GOVERNORS}${NC}"
        show_current
        ;;
    "help"|"-h")
        echo -e "${CYAN}–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:${NC} sudo $0 [—Ä–µ–∂–∏–º]"
        echo -e "${GREEN}  p, perf    ${NC} - üöÄ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"
        echo -e "${GREEN}  ps         ${NC} - üîã –≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ"  
        echo -e "${GREEN}  o          ${NC} - ‚ö° –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"
        echo -e "${GREEN}  s          ${NC} - ‚ö° –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π"
        echo -e "${GREEN}  cur        ${NC} - üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
        ;;
    *)
        echo -e "${RED}√ó${NC} –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º: ${GOVERNOR}"
        echo -e "${YELLOW}‚Ñπ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:${NC} p, ps, o, s, cur"
        ;;
esac
