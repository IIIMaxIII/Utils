#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è CPU governor –∏ —á–∞—Å—Ç–æ—Ç–∞–º–∏
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sudo ./governor.sh [—Ä–µ–∂–∏–º|–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è_—á–∞—Å—Ç–æ—Ç–∞]

GOVERNOR="${1:---current}"
AVAILABLE_GOVERNORS=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors 2>/dev/null)

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;94m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# –ò–∫–æ–Ω–∫–∏
ICON_CPU="üíª"
ICON_PERF="üöÄ"
ICON_SAVE="üîã"
ICON_ADAPT="‚ö°"
ICON_CUR="üìä"
ICON_FREQ="üéØ"
ICON_RESET="üîÑ"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}√ó${NC} –¢—Ä–µ–±—É—é—Ç—Å—è root –ø—Ä–∞–≤–∞"
    exit 1
fi

get_cpu_info() {
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–ø–æ–ª–æ–≥–∏–∏
    PHYSICAL_CORES=$(lscpu | grep "Core(s) per socket" | awk '{print $4}')
    SOCKETS=$(lscpu | grep "Socket(s)" | awk '{print $2}')
    THREADS_PER_CORE=$(lscpu | grep "Thread(s) per core" | awk '{print $4}')
    
    TOTAL_PHYSICAL_CORES=$((PHYSICAL_CORES * SOCKETS))
    TOTAL_THREADS=$((TOTAL_PHYSICAL_CORES * THREADS_PER_CORE))
    
    echo "${TOTAL_PHYSICAL_CORES}:${TOTAL_THREADS}:${THREADS_PER_CORE}"
}

show_compact_freq() {
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–ø–æ–ª–æ–≥–∏–∏
    IFS=":" read -r PHYSICAL_CORES TOTAL_THREADS THREADS_PER_CORE <<< $(get_cpu_info)
    
    echo -e "${BLUE}‚îî‚îÄ‚îÄ –ß–∞—Å—Ç–æ—Ç—ã –ø–æ—Ç–æ–∫–æ–≤:${NC}"
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–∞—Å—Ç–æ—Ç—ã
    freqs=$(cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq | awk '{printf "%.1f\n", $1/1000000}')
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–∞–º
    freq_stats=$(echo "$freqs" | sort -n | uniq -c | awk '{printf "   %d @ %s GHz\n", $1, $2}')
    
    # –í—ã–≤–æ–¥–∏–º –∫–æ–º–ø–∞–∫—Ç–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if [ $(echo "$freq_stats" | wc -l) -eq 1 ]; then
        echo -e "   ${GREEN}–í—Å–µ @ $(echo "$freqs" | head -1) GHz${NC}"
    else
        echo "$freq_stats"
    fi
}

show_current() {
    CURRENT_GOV=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–ø–æ–ª–æ–≥–∏–∏
    IFS=":" read -r PHYSICAL_CORES TOTAL_THREADS THREADS_PER_CORE <<< $(get_cpu_info)
    
    echo -e "${CYAN}${ICON_CUR} –¢–µ–∫—É—â–∏–π: ${PURPLE}${CURRENT_GOV}${NC}"
    echo -e "${BLUE}‚îú‚îÄ‚îÄ –¢–æ–ø–æ–ª–æ–≥–∏—è: ${YELLOW}${PHYSICAL_CORES} —è–¥–µ—Ä √ó ${THREADS_PER_CORE} –ø–æ—Ç–æ–∫–∞ = ${TOTAL_THREADS} –ø–æ—Ç–æ–∫–æ–≤${NC}"
    show_compact_freq
}

set_governor() {
    local target_gov="$1"
    local icon="$2"
    local name="$3"
    
    echo -e "${icon} –£—Å—Ç–∞–Ω–æ–≤–∫–∞: ${GREEN}${name}${NC}"
    
    for gov_file in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
        echo "$target_gov" > "$gov_file"
    done
    
    sleep 0.3
    show_current
}

set_max_frequency() {
    local freq_mhz=$1
    local freq_khz=$((freq_mhz * 1000))
    
    echo -e "${ICON_FREQ} –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–æ—Ç—ã: ${GREEN}${freq_mhz} MHz${NC}"
    echo -e "${GREEN}‚úì CPU –±—É–¥–µ—Ç —Å–Ω–∏–∂–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É –≤ –ø—Ä–æ—Å—Ç–æ–µ –¥–ª—è —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è${NC}"
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —á–∞—Å—Ç–æ—Ç—É, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π governor
    for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
        echo "$freq_khz" > "$cpu/cpufreq/scaling_max_freq" 2>/dev/null
        echo "ondemand" > "$cpu/cpufreq/scaling_governor" 2>/dev/null
    done
    
    sleep 0.3
    show_current
}

reset_frequency() {
    echo -e "${ICON_RESET} –°–±—Ä–æ—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —á–∞—Å—Ç–æ—Ç—ã: ${GREEN}–ø–æ–ª–Ω–æ–µ —Å–Ω—è—Ç–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π${NC}"
    
    # –°–Ω–∏–º–∞–µ–º –≤—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–æ—Ç—ã
    for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
        local max_freq=$(cat "$cpu/cpufreq/cpuinfo_max_freq" 2>/dev/null)
        echo "$max_freq" > "$cpu/cpufreq/scaling_max_freq" 2>/dev/null
        echo "ondemand" > "$cpu/cpufreq/scaling_governor" 2>/dev/null
    done
    
    sleep 0.3
    show_current
}

show_help() {
    echo -e "${CYAN}–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:${NC} sudo $0 [—Ä–µ–∂–∏–º|–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è_—á–∞—Å—Ç–æ—Ç–∞]"
    echo
    echo -e "${GREEN}–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:${NC}"
    echo -e "  -p, --performance   - üöÄ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"
    echo -e "  -e, --powersave     - üîã –≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ"
    echo -e "  -o, --ondemand      - ‚ö° –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"  
    echo -e "  -s, --schedutil     - ‚ö° –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π"
    echo -e "  -c, --current       - üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
    echo -e "  -r, --reset         - üîÑ –°–±—Ä–æ—Å –≤—Å–µ—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —á–∞—Å—Ç–æ—Ç—ã"
    echo
    echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–æ—Ç—ã:${NC}"
    echo -e "  2000, 2400, 2800    - üìà –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ (—Å —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ–º)"
    echo
    echo -e "${YELLOW}–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:${NC} CPU –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–∂–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É"
    echo -e "–≤ –ø—Ä–æ—Å—Ç–æ–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —ç–Ω–µ—Ä–≥–∏–∏"
}

case "${GOVERNOR}" in
    "-p"|"--performance")
        set_governor "performance" "${ICON_PERF}" "–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨"
        ;;
    "-e"|"--powersave")
        set_governor "powersave" "${ICON_SAVE}" "–≠–ù–ï–†–ì–û–°–ë–ï–†–ï–ñ–ï–ù–ò–ï"
        ;;
    "-o"|"--ondemand")
        set_governor "ondemand" "${ICON_ADAPT}" "–ê–î–ê–ü–¢–ò–í–ù–´–ô –†–ï–ñ–ò–ú"
        ;;
    "-s"|"--schedutil")
        set_governor "schedutil" "${ICON_ADAPT}" "–°–û–í–†–ï–ú–ï–ù–ù–´–ô –ê–î–ê–ü–¢–ò–í–ù–´–ô"
        ;;
    "-r"|"--reset")
        reset_frequency
        ;;
    "-c"|"--current"|"")
        echo -e "${CYAN}${ICON_CPU} –°–æ—Å—Ç–æ—è–Ω–∏–µ CPU${NC}"
        echo -e "${BLUE}‚îú‚îÄ‚îÄ –î–æ—Å—Ç—É–ø–Ω—ã–µ: ${YELLOW}${AVAILABLE_GOVERNORS}${NC}"
        show_current
        ;;
    
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ (–ø—Ä–æ—Å—Ç–æ —Ü–∏—Ñ—Ä—ã)
    [0-9]*)
        if [[ "${GOVERNOR}" =~ ^[0-9]+$ ]]; then
            set_max_frequency "${GOVERNOR}"
        else
            echo -e "${RED}√ó${NC} –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —á–∞—Å—Ç–æ—Ç—ã: ${GOVERNOR}"
        fi
        ;;
    
    # –°–ø—Ä–∞–≤–∫–∞
    "-h"|"--help")
        show_help
        ;;
    
    # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç
    *)
        echo -e "${RED}√ó${NC} –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º: ${GOVERNOR}"
        echo -e "${YELLOW}‚Ñπ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:${NC} sudo $0 --help"
        ;;
esac
